version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Installing backend dependencies"
      - npm install

  post_build:
    commands:
      - echo "Deploying backend to private EC2 via SSM"
      - >
        aws ssm send-command
        --document-name "AWS-RunShellScript"
        --targets "Key=tag:Name,Values=backend-private-ec2"
        --comment "Deploy backend from CodeBuild"
        --parameters commands="
          sudo mkdir -p /home/ubuntu/app &&
          sudo rm -rf /home/ubuntu/app/* &&
          sudo cp -r . /home/ubuntu/app &&
          cd /home/ubuntu/app &&
          npm install &&
          pm2 restart backend || pm2 start index.js --name backend
        "
